<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles/roomadmin_style.css">
    <title>QUIZAI</title>
</head>

<body>
<div class="main_cont">

    <main>
        <div class="left">
            <header>
                <a href="main.html" class="btn_back">–ù–ê–ó–ê–î</a>
                <h1 class="h11">QUIZ AI ARENA</h1>
            </header>

            <div class="players">
                <div class="players-header">
                    <span class="players-title">–£–ß–ê–°–¢–ù–ò–ö–ò:</span>
                    <span id="players-count" class="players-count">0/0</span>
                </div>
                <div id="players-container" class="players-list">
                    <!-- –ò–≥—Ä–æ–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>

        <div class="main_blockr">
            <div class="room-info-section">
                <div class="room-info-label">CC–´–õ–ö–ê-–ü–†–ò–ì–õ–ê–®–ï–ù–ò–ï:</div>
                <div class="room-info-value">
                    <span id="invite-link">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    <span class="copy-icon" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</span>
                </div>

                <div class="room-info-label">ID-–ö–í–ò–ó–ê:</div>
                <div class="room-info-value" id="invite-id">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>

            <div class="questions-status-section">
                <div class="questions-status-label">–°–¢–ê–¢–£–° –í–û–ü–†–û–°–û–í:</div>
                <div id="questions-status" class="questions-status-value loading">
                    <span class="status-icon">‚è≥</span>
                    <span class="status-text">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤</span>
                    <span class="loading-dots"></span>
                </div>
            </div>

            <div class="room-info-section">
                <span>–ò–ó–ú–ï–ù–ò–¢–¨ –ü–†–ò–í–ê–¢–ù–û–°–¢–¨ –ö–û–ú–ù–ê–¢–´:</span>
                <div class="isprivate block_hor">
                    <a href="#" class="btnprivate privacy-btn" data-private="false">–û–¢–ö–†–´–¢–ê–Ø</a>
                    <a href="#" class="btnprivate privacy-btn" data-private="true">–ó–ê–ö–†–´–¢–ê–Ø</a>
                </div>

                <span>–¢–ï–ú–ê –ö–í–ò–ó–ê:</span>
                <div class="theme">
                    <div id="quiz-theme" class="h11">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <a href="#" class="btnstart disabled" id="start-quiz-btn">–ù–ê–ß–ê–¢–¨ –ö–í–ò–ó –î–û–°–†–û–ß–ù–û</a>
            <div id="start-quiz-message" class="message" style="display: none;"></div>
        </div>
    </main>
</div>

<script src="/js/auth.js"></script>
<script>
    let gameId = null;
    let refreshInterval = null;
    let maxPlayers = 10; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤
    let isPrivate = false; // –¢–µ–∫—É—â–∞—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∫–æ–º–Ω–∞—Ç—ã
    let currentPlayers = []; // –¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
    let isQuizStarting = false; // –§–ª–∞–≥, —á—Ç–æ –∫–≤–∏–∑ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è

    document.addEventListener('DOMContentLoaded', function () {
      if (!AuthService.requireAuth()) return;

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—É –∏–∑ localStorage –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ—ë
      loadThemeFromLocalStorage();

      // –ü–æ–ª—É—á–∞–µ–º gameId –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      const urlParams = new URLSearchParams(window.location.search);
      gameId = urlParams.get('gameId');

      if (!gameId) {
        console.error('Game ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL');
        return;
      }

      initializeRoom();
      setupEventListeners();
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã –∏–∑ localStorage
    function loadThemeFromLocalStorage() {
      try {
        const themeElement = document.getElementById('quiz-theme');
        const selectedTopicData = localStorage.getItem('selectedTopic');

        if (selectedTopicData) {
          const selectedTopic = JSON.parse(selectedTopicData);
          themeElement.textContent = selectedTopic.name;
        } else {
          themeElement.textContent = '–¢–µ–º–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
          console.warn('–¢–µ–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ localStorage');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º—ã –∏–∑ localStorage:', error);
        document.getElementById('quiz-theme').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º—ã';
      }
    }

    function initializeRoom() {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã
      loadRoomData();

      // –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
      refreshInterval = setInterval(loadPlayers, 5000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

      // –°—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      loadPlayers();
    }

    function setupEventListeners() {
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
      document.querySelectorAll('.privacy-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          changeRoomPrivacy(this.dataset.private === 'true');
        });
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞
      document.getElementById('start-quiz-btn').addEventListener('click', function (e) {
        e.preventDefault();
        startQuiz();
      });
    }

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –∫–æ–º–Ω–∞—Ç—ã
    async function changeRoomPrivacy(newPrivacy) {
      try {
        const session = AuthService.getsession();

        const response = await fetch('http://localhost:8080/api/game/set/private', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            gameId: parseInt(gameId),
            isPrivate: newPrivacy
          })
        });

        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updatePrivacyButtons(newPrivacy);
        isPrivate = newPrivacy;

        showPrivacyMessage(`–ö–æ–º–Ω–∞—Ç–∞ —Ç–µ–ø–µ—Ä—å ${newPrivacy ? '–ó–ê–ö–†–´–¢–ê–Ø' : '–û–¢–ö–†–´–¢–ê–Ø'}`, 'success');

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –∫–æ–º–Ω–∞—Ç—ã:', error);
        showPrivacyMessage('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏: ' + error.message, 'error');
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
    function updatePrivacyButtons(privacy) {
      // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
      document.querySelectorAll('.privacy-btn').forEach(b => {
        b.classList.remove('active');
      });

      // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
      const activeButton = document.querySelector(`.privacy-btn[data-private="${privacy}"]`);
      if (activeButton) {
        activeButton.classList.add('active');
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
    function showPrivacyMessage(text, type) {
      // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
      alert(text); // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ - –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∫—Ä–∞—Å–∏–≤—ã–π toast
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
    function updateQuestionsStatus() {
        const statusElement = document.getElementById('questions-status');
        const statusText = statusElement.querySelector('.status-text');
        const statusIcon = statusElement.querySelector('.status-icon');

        if (questionsReady) {
            statusElement.className = 'questions-status-value ready';
            statusIcon.textContent = '‚úÖ';
            statusText.textContent = '–í–æ–ø—Ä–æ—Å—ã –≥–æ—Ç–æ–≤—ã';
            statusElement.title = '–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã';
        } else {
            statusElement.className = 'questions-status-value loading';
            statusIcon.textContent = '‚è≥';
            statusText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤';
            statusElement.title = '–ò–ò –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –∫–≤–∏–∑–∞...';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç—ã
    async function loadRoomData() {
      try {
        const session = AuthService.getsession();

        const response = await fetch('http://localhost:8080/api/game/join', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            session: session,
            gameId: parseInt(gameId)
          })
        });

        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
        }

        const roomData = await response.json();

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–Ω–∞—Ç–µ
        updateRoomInfo(roomData);

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç—ã:', error);
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
    async function loadPlayers() {
      try {
        const session = AuthService.getsession();

        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤...', new Date().toLocaleTimeString());

        // TODO: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
        const players = await fetchPlayersFromServer();
        currentPlayers = players; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
        displayPlayers(players);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –ª–∏ –∫–æ–º–Ω–∞—Ç–∞
        checkRoomFull(players);

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤:', error);
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
    function checkRoomFull(players) {
      if (players.length >= maxPlayers && !isQuizStarting) {
        // –ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ–º –∫–≤–∏–∑
        showMessage('–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞! –ù–∞—á–∏–Ω–∞–µ–º –∫–≤–∏–∑...', 'info');
        disableStartButton();
        startQuiz();
      }
    }

    // –†–µ–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function fetchPlayersFromServer() {
      try {
        const session = AuthService.getsession();

        const response = await fetch('http://localhost:8080/api/game/get/lobby', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            gameId: parseInt(gameId)
          })
        });

        console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        console.log('–ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', response.headers);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
          throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status} - ${errorText}`);
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π
        const responseText = await response.text();
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', responseText);

        if (!responseText) {
          console.warn('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
          return [];
        }

        const lobbyData = JSON.parse(responseText);
        console.log('–ü–∞—Ä—Å–∏–Ω–≥ JSON —É—Å–ø–µ—à–µ–Ω:', lobbyData);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ playersUsernames
        if (!lobbyData.playersUsernames) {
          console.warn('–ü–æ–ª–µ playersUsernames –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –æ—Ç–≤–µ—Ç–µ');
          return [];
        }

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∞—Å—Å–∏–≤ –∏–º–µ–Ω –∏–≥—Ä–æ–∫–æ–≤ –≤ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
        const players = lobbyData.playersUsernames.map((username, index) => ({
          username: username,
          userId: index + 1
        }));

        console.log('–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∏:', players);
        return players;

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        return [];
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
    function displayPlayers(players) {
      const container = document.getElementById('players-container');
      const countElement = document.getElementById('players-count');

      container.innerHTML = '';

      if (players.length === 0) {
        container.innerHTML = '<div class="no-players">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
        countElement.textContent = '0/' + maxPlayers;

        // –ï—Å–ª–∏ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤, –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å—Ç–∞—Ä—Ç–∞
        disableStartButton();
        return;
      }

      players.forEach(player => {
        const playerElement = document.createElement('div');
        playerElement.className = 'player';
        playerElement.textContent = player.username;
        container.appendChild(playerElement);
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏–≥—Ä–æ–∫–æ–≤
      countElement.textContent = `${players.length}/${maxPlayers}`;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏/–¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ä—Ç–∞
      if (players.length < 2) {
        disableStartButton('–î–ª—è –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞');
      } else {
        enableStartButton();
      }

      // –õ–æ–≥–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      console.log(`–û–±–Ω–æ–≤–ª–µ–Ω —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤: ${players.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`);
    }

    // –í–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞
    function enableStartButton() {
      const startBtn = document.getElementById('start-quiz-btn');
      startBtn.classList.remove('disabled');
      startBtn.style.pointerEvents = 'auto';
      startBtn.style.opacity = '1';
    }

    // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞
    function disableStartButton(message = '') {
      const startBtn = document.getElementById('start-quiz-btn');
      startBtn.classList.add('disabled');
      startBtn.style.pointerEvents = 'none';
      startBtn.style.opacity = '0.5';

      if (message) {
        showMessage(message, 'warning');
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    function showMessage(text, type) {
      const messageElement = document.getElementById('start-quiz-message');
      messageElement.textContent = text;
      messageElement.className = `message ${type}`;
      messageElement.style.display = 'block';

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        messageElement.style.display = 'none';
      }, 5000);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–Ω–∞—Ç–µ
    function updateRoomInfo(roomData) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
        const linkElement = document.getElementById('invite-link');
        const fullLink = `${window.location.origin}/room.html?gameId=${gameId}`;
        linkElement.textContent = fullLink;

        const IDElement = document.getElementById('invite-id');
        IDElement.textContent = `${gameId}`;

        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É
        document.querySelector('.copy-icon').addEventListener('click', function () {
            navigator.clipboard.writeText(fullLink)
                .then(() => {
                    const originalText = this.textContent;
                    this.textContent = '‚úÖ';
                    setTimeout(() => {
                        this.textContent = originalText;
                    }, 2000);
                })
                .catch(err => console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err));
        });

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç—ã
        if (roomData.isPrivate !== undefined) {
            isPrivate = roomData.isPrivate;
            updatePrivacyButtons(isPrivate);
        }

        // –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (roomData.participantsNumber) {
            maxPlayers = roomData.participantsNumber;
            // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            document.getElementById('players-count').textContent = `0/${maxPlayers}`;
        }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
    document.querySelector('.btn_back').addEventListener('click', function (e) {
      e.preventDefault();
      confirmExit();
    });

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞
    function confirmExit() {
      const confirmed = confirm('–ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∫–æ–º–Ω–∞—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?');

      if (confirmed) {
        stopGameAndExit();
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–≥—Ä—ã –∏ –≤—ã—Ö–æ–¥–∞
    async function stopGameAndExit() {
      try {
        const session = AuthService.getsession();

        const response = await fetch('http://localhost:8080/api/game/delete', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            gameId: parseInt(gameId)
          })
        });

        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
        }

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }

        localStorage.removeItem('currentGameId');
        localStorage.removeItem('selectedTopic');
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        window.location.href = 'main.html';

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–≥—Ä—ã:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã: ' + error.message);
      }
    }

    // –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –≤–∫–ª–∞–¥–∫–∏/–±—Ä–∞—É–∑–µ—Ä–∞
    window.addEventListener('beforeunload', function (e) {
      // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É—Ö–æ–¥–∏—Ç —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      if (!isNavigatingToQuiz) {
        // –î–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ –º—ã –Ω–µ –º–æ–∂–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∑–¥–µ—Å—å,
        // –Ω–æ –º–æ–∂–µ–º –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        e.preventDefault();
        e.returnValue = '–ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∫–æ–º–Ω–∞—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?';
        return e.returnValue;
      }
    });

    // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    let isNavigatingToQuiz = false;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é startQuiz –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–ª–∞–≥–∞
    async function startQuiz() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º
      if (currentPlayers.length < 2) {
        showMessage('–î–ª—è –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞', 'error');
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—á–∞—Ç –ª–∏ —É–∂–µ –∫–≤–∏–∑
      if (isQuizStarting) {
        showMessage('–ö–≤–∏–∑ —É–∂–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...', 'info');
        return;
      }

      try {
        isQuizStarting = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞
        isNavigatingToQuiz = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞
        disableStartButton('–ö–≤–∏–∑ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è...');

        const session = AuthService.getsession();

        const response = await fetch('http://localhost:8080/api/game/start', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            gameId: parseInt(gameId)
          })
        });

        if (!response.ok) {
          throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
        }

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }

        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
        window.location.href = `question.html?gameId=${gameId}`;

      } catch (error) {
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏
        isQuizStarting = false;
        isNavigatingToQuiz = false;

        console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞:', error);
        showMessage('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∫–≤–∏–∑–∞: ' + error.message, 'error');

        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        if (currentPlayers.length >= 2) {
          enableStartButton();
        }
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    window.addEventListener('beforeunload', function (e) {
      // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É—Ö–æ–¥–∏—Ç —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–µ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∫–≤–∏–∑)
      if (!isNavigatingToQuiz) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏/–±—Ä–∞—É–∑–µ—Ä–∞
        e.preventDefault();
        e.returnValue = '–ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∫–æ–º–Ω–∞—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?';
        return e.returnValue;
      }

      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –ø—Ä–∏ –ª—é–±–æ–º —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
</script>
</body>

</html>