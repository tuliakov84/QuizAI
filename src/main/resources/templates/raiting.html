<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles/raiting_style.css">
    <title>QUIZAI - Рейтинг</title>
</head>

<body>
<div class="main_cont">
    <header>
        <a href="main.html" class="btn_back">НАЗАД</a>
        <h1 class="h11">QUIZ AI ARENA</h1>
    </header>

    <p class="h12">БЕСКОНЕЧНОСТЬ НЕ ПРЕДЕЛ!</p>

    <main>
        <div class="raiting">
            <div>
            </div>
            <div>
          <span>
            ВАШЕ МЕСТО В РЕЙТИНГЕ:
          </span>
                <span id="user-rank">
            Не в топе
          </span>
            </div>
        </div>

        <div class="players">
            <div class="players-header">ТОП ИГРОКОВ ПО РЕЙТИНГУ</div>
            <div class="player template">
                <!-- Шаблон для игроков -->
                <div class="player-info">
                    <span class="player-rank">1</span>
                    <div class="player-avatar"></div>
                    <span class="player-name">Имя игрока</span>
                    <span class="player-points">1000 очков</span>
                </div>
            </div>
        </div>
    </main>
</div>
</body>

<script src="/js/auth.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
      if (!AuthService.requireAuth()) return;
      loadGlobalLeaderboard();
    });

    async function loadGlobalLeaderboard() {
      try {
        const userData = AuthService.getUser();
        let currentUsername = userData?.username;

        if (!currentUsername) {
          console.error('Имя пользователя не найдено в localStorage');
          const rawUser = localStorage.getItem('user');
          if (rawUser) {
            const parsedUser = JSON.parse(rawUser);
            if (parsedUser.username) {
              currentUsername = parsedUser.username;
            }
          }

          if (!currentUsername) {
            console.error('Имя пользователя не найдено');
            showError('Требуется авторизация');
            return;
          }
        }

        console.log('Загружаем рейтинг для пользователя:', currentUsername);

        const response = await fetch('http://localhost:8080/api/leaderboard/get/global', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          mode: 'cors',
          credentials: 'include'
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Ошибка сервера:', response.status, errorText);
          throw new Error(`Ошибка HTTP: ${response.status}`);
        }

        const leaderboardData = await response.json();
        console.log('Получены данные рейтинга:', leaderboardData);

        if (!Array.isArray(leaderboardData)) {
          console.error('Некорректный формат данных:', leaderboardData);
          throw new Error('Некорректный формат данных рейтинга');
        }

        // Преобразуем данные
        const players = leaderboardData.map(item => ({
          id: item[0],
          username: item[1],
          points: item[2] || 0,
          possible: item[3] || 0
        }));

        // Сортируем по очкам (по убыванию) - от большего к меньшему
        players.sort((a, b) => {
          if (b.points > a.points) return -1;
          if (b.points < a.points) return 1;
          return 0;
        });

        // Отображаем в порядке по возрастанию (от 1-го места к последнему)
        displayLeaderboard(players, currentUsername);

      } catch (error) {
        console.error('Ошибка загрузки рейтинга:', error);
        showError('Не удалось загрузить рейтинг игроков: ' + error.message);
      }
    }

    function displayLeaderboard(players, currentUsername) {
      const playersContainer = document.querySelector('.players');
      const template = document.querySelector('.player.template');

      // Очищаем существующих игроков (кроме шаблона)
      const existingPlayers = playersContainer.querySelectorAll('.player:not(.template)');
      existingPlayers.forEach(player => player.remove());

      // Удаляем сообщения об ошибке/пустом рейтинге
      const existingError = playersContainer.querySelector('.error-message');
      if (existingError) existingError.remove();

      const noPlayersMessage = playersContainer.querySelector('.no-players-message');
      if (noPlayersMessage) noPlayersMessage.remove();

      if (!players || players.length === 0) {
        const noPlayersMsg = document.createElement('div');
        noPlayersMsg.className = 'no-players-message';
        noPlayersMsg.textContent = 'Рейтинг пока пуст. Будьте первым!';
        playersContainer.appendChild(noPlayersMsg);
        return;
      }

      // Находим текущего пользователя в рейтинге
      const currentUserIndex = players.findIndex(p => p.username === currentUsername);
      const currentUser = currentUserIndex !== -1 ? players[currentUserIndex] : null;

      // Обновляем информацию о текущем пользователе
      updateUserStats(currentUser, players.length - currentUserIndex);

      players.forEach((player, index) => {
        const playerElement = template.cloneNode(true);
        playerElement.classList.remove('template');
        playerElement.style.display = 'block';

        // Заполняем данные игрока
        const rankElement = playerElement.querySelector('.player-rank');
        const avatarElement = playerElement.querySelector('.player-avatar');
        const nameElement = playerElement.querySelector('.player-name');
        const pointsElement = playerElement.querySelector('.player-points');

        // Устанавливаем место в рейтинге
        rankElement.textContent = players.length - index;

        // Имя игрока
        nameElement.textContent = player.username;

        // Аватар - первая буква имени
        avatarElement.textContent = player.username.charAt(0).toUpperCase();

        // Очки
        pointsElement.textContent = `${player.points} очков`;

        // Выделяем текущего пользователя
        if (currentUsername && player.username === currentUsername) {
          playerElement.classList.add('current-user');
        }

        // Добавляем атрибуты
        playerElement.setAttribute('data-player-id', player.id);
        playerElement.setAttribute('data-rank', players.length - index);

        // Вставляем после шаблона
        template.parentNode.insertBefore(playerElement, template.nextSibling);
      });

      // Скрываем шаблон
      template.style.display = 'none';
    }

    function updateUserStats(user, rank) {
      const userRankElement = document.getElementById('user-rank');

      if (user) {
        userRankElement.textContent = rank || 'Не в топе';
      } else {
        const currentUser = AuthService.getUser();
        userRankElement.textContent = 'Не в топе';
      }
    }

    function showError(message) {
      const existingError = document.querySelector('.error-message');
      if (existingError) {
        existingError.remove();
      }

      const errorElement = document.createElement('div');
      errorElement.className = 'error-message';
      errorElement.textContent = message;

      const header = document.querySelector('header');
      if (header && header.parentNode) {
        header.parentNode.insertBefore(errorElement, header.nextSibling);
      } else {
        document.body.insertBefore(errorElement, document.body.firstChild);
      }

      setTimeout(() => {
        if (errorElement.parentNode) {
          errorElement.remove();
        }
      }, 5000);
    }

    // Функция для обновления рейтинга
    function refreshLeaderboard() {
      const existingError = document.querySelector('.error-message');
      if (existingError) {
        existingError.remove();
      }

      const noPlayersMessage = document.querySelector('.no-players-message');
      if (noPlayersMessage) {
        noPlayersMessage.remove();
      }

      const playersContainer = document.querySelector('.players');
      if (playersContainer) {
        playersContainer.classList.add('loading');
      }

      loadGlobalLeaderboard().then(() => {
        if (playersContainer) {
          playersContainer.classList.remove('loading');
        }
      });
    }

    // Автообновление рейтинга каждые 30 секунд
    setInterval(refreshLeaderboard, 10000);
</script>
</html>