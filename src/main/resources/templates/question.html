<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles/question_style.css">
    <title>QUIZAI</title>
</head>

<body>
<div class="main_cont">
    <header>
        <div class="h12">
            ВРЕМЯ НА ВОПРОС
        </div>
        <div class="timer">
            <div class="currenttime">
            </div>
        </div>
    </header>

    <main>
        <div class="question">
            <div class="h13" id="question-text">Загрузка вопроса...</div>
        </div>
        <div class="answers" id="answers-container">
            <!-- Ответы будут загружены через JavaScript -->
        </div>
    </main>
</div>
</body>

<script src="/js/auth.js"></script>
<script>
    let gameId = null;
    let currentQuestionNumber = 1;
    let totalQuestions = 10;
    let timeLeft = 30;
    let timerWorker = null;
    let answerSubmitted = false;
    let selectedAnswer = null;
    let questionStartTime = null;
    let animationFrameId = null;
    let currentQuestionData = null; // Для хранения данных текущего вопроса
    let levelDifficulty = null; // Сложность игры
    let timePerQuestion = 30; // Время на ответ по умолчанию

    document.addEventListener('DOMContentLoaded', function () {
      if (!AuthService.requireAuth()) return;

      const urlParams = new URLSearchParams(window.location.search);
      gameId = urlParams.get('gameId');

      if (!gameId) {
        console.error('Game ID не найден в URL');
        return;
      }

      // Получаем информацию об игре для определения сложности и времени
      loadGameInfo();

      // Инициализируем Web Worker для таймера
      try {
        timerWorker = new Worker('js/timer-worker.js');
        timerWorker.onmessage = function(e) {
          if (e.data.type === 'timeout') {
            handleTimeout();
          } else if (e.data.type === 'tick') {
            // Обновляем время с высокой точностью
            timeLeft = e.data.remainingMs / 1000;
            updateTimerDisplay();
          }
        };
      } catch (error) {
        console.error('Web Worker не поддерживается:', error);
        // Fallback на обычный таймер
      }

      loadQuestion();
    });

    // Загрузка информации об игре (сложность, количество вопросов)
    async function loadGameInfo() {
      try {
        const session = AuthService.getsession();

        const response = await fetch('http://localhost:8080/api/game/join', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            session: session,
            gameId: parseInt(gameId)
          })
        });

        if (!response.ok) {
          throw new Error(`Ошибка HTTP: ${response.status}`);
        }

        const gameData = await response.json();

        // Получаем количество вопросов и сложность
        totalQuestions = gameData.numberOfQuestions || 10;

        // Сохраняем сложность для отправки с ответом
        levelDifficulty = gameData.levelDifficulty;

        timeLeft = timePerQuestion;

        console.log(`Игра: ${gameId}, Вопросов: ${totalQuestions}, Время на ответ: ${timePerQuestion}с`);

      } catch (error) {
        console.error('Ошибка загрузки информации об игре:', error);
      }
    }

    async function loadQuestion() {
      try {
        // Сбрасываем состояние
        answerSubmitted = false;
        selectedAnswer = null;
        timeLeft = timePerQuestion;

        const session = AuthService.getsession();

        // Получаем вопрос с сервера
        const response = await fetch('http://localhost:8080/api/game/get/question', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            gameId: parseInt(gameId),
            questionNumber: currentQuestionNumber
          })
        });

        if (!response.ok) {
          throw new Error(`Ошибка HTTP: ${response.status}`);
        }

        const questionData = await response.json();
        currentQuestionData = questionData;

        // Отображаем вопрос
        displayQuestion(questionData);

        // Запускаем таймер после загрузки вопроса
        startTimer();

      } catch (error) {
        console.error('Ошибка загрузки вопроса:', error);
        // В случае ошибки можно показать сообщение или перейти к следующему вопросу
        setTimeout(() => {
          goToNextQuestion();
        }, 2000);
      }
    }

    function displayQuestion(question) {
      document.getElementById('question-text').textContent = question.questionText || "Вопрос не загружен";

      const answersContainer = document.getElementById('answers-container');
      answersContainer.innerHTML = '';

      // Создаем кнопки для каждого ответа
      const answers = [
        { text: question.answer1, number: 1 },
        { text: question.answer2, number: 2 },
        { text: question.answer3, number: 3 },
        { text: question.answer4, number: 4 }
      ];

      answers.forEach((answer) => {
        if (answer.text && answer.text.trim() !== '') {
          const answerBtn = document.createElement('a');
          answerBtn.href = '#';
          answerBtn.className = 'btn';
          answerBtn.textContent = `${answer.number}. ${answer.text}`;
          answerBtn.dataset.answerNumber = answer.number;

          answerBtn.addEventListener('click', function (e) {
            e.preventDefault();
            if (!answerSubmitted) {
              selectAnswer(answer.number);
            }
          });

          answersContainer.appendChild(answerBtn);
        }
      });

      // Если нет ни одного ответа, показываем сообщение
      if (answersContainer.children.length === 0) {
        const errorMessage = document.createElement('div');
        errorMessage.className = 'error-message';
        errorMessage.textContent = 'Ответы не загружены';
        answersContainer.appendChild(errorMessage);
      }

      console.log(`Вопрос ${currentQuestionNumber}/${totalQuestions} загружен`);
    }

    function selectAnswer(answerNumber) {
      if (answerSubmitted) return;

      selectedAnswer = answerNumber;
      answerSubmitted = true;

      // Выделяем выбранный ответ
      const answerButtons = document.querySelectorAll('.btn');
      answerButtons.forEach(btn => {
        btn.classList.remove('selected');
        if (parseInt(btn.dataset.answerNumber) === answerNumber) {
          btn.classList.add('selected');
        }
      });

      // Блокируем все кнопки
      disableAllAnswers();

      console.log(`Выбран ответ: ${answerNumber}. Ожидание окончания таймера...`);
    }

    function disableAllAnswers() {
      const answerButtons = document.querySelectorAll('.btn');
      answerButtons.forEach(btn => {
        btn.classList.add('disabled-answer');
      });
    }

    function startTimer() {
      questionStartTime = Date.now();
      timeLeft = timePerQuestion;
      updateTimerDisplay();

      if (timerWorker) {
        // Используем Web Worker для точного таймера
        timerWorker.postMessage({
          action: 'start',
          duration: timePerQuestion * 1000
        });
      } else {
        // Fallback: обычный таймер (менее точный)
        startFallbackTimer();
      }
    }

    function startFallbackTimer() {
      const startTime = Date.now();
      const endTime = startTime + (timePerQuestion * 1000);

      function updateTimer() {
        const now = Date.now();
        const remainingTime = endTime - now;

        if (remainingTime <= 0) {
          handleTimeout();
          return;
        }

        timeLeft = remainingTime / 1000;
        updateTimerDisplay();

        animationFrameId = requestAnimationFrame(updateTimer);
      }

      animationFrameId = requestAnimationFrame(updateTimer);
    }

    function handleTimeout() {
      console.log('Время вышло!');

      // Останавливаем таймер
      if (timerWorker) {
        timerWorker.postMessage('stop');
      }
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }

      // Гарантируем, что таймер показывает 0
      timeLeft = 0;
      updateTimerDisplay();

      // Если ответ не был выбран, выбираем 0
      if (!answerSubmitted) {
        selectedAnswer = 0;
        answerSubmitted = true;
      }

      // Даем время для завершения визуальной анимации
      setTimeout(() => {
        submitAnswer(selectedAnswer);
      }, 500);
    }

    function updateTimerDisplay() {
      const timerElement = document.querySelector('.currenttime');

      // Плавное отображение с точностью до десятых долей секунды
      const percentage = (timeLeft / timePerQuestion) * 100;
      timerElement.style.width = `${Math.max(0, percentage)}%`;

      // Плавное изменение цвета таймера от зеленого к красному
      if (timeLeft <= timePerQuestion * 0.25) { // Последние 25% времени
        timerElement.style.backgroundColor = '#ff5252';
      } else if (timeLeft <= timePerQuestion * 0.5) { // Последние 50% времени
        timerElement.style.backgroundColor = '#ffa726';
      } else {
        timerElement.style.backgroundColor = '#4CAF50';
      }

      // Плавная анимация
      timerElement.style.transition = 'width 0.05s linear, background-color 0.3s ease';

      // Обновляем текст таймера (если есть элемент для текста)
      const timerText = document.querySelector('.timer-text');
      if (timerText) {
        timerText.textContent = Math.ceil(timeLeft) + 'с';
      }
    }

    async function submitAnswer(answerNumber) {
      try {
        const session = AuthService.getsession();
        const timeTaken = timePerQuestion - timeLeft; // Время, затраченное на ответ

        console.log(`Отправка ответа: ${answerNumber}, время: ${timeTaken.toFixed(1)}с, сложность: ${levelDifficulty}`);

        // Преобразуем числовую сложность в enum формат
        let difficultyEnum = 'MEDIUM'; // По умолчанию
        if (levelDifficulty === 1) {
          difficultyEnum = 'EASY';
        } else if (levelDifficulty === 2) {
          difficultyEnum = 'MEDIUM';
        } else if (levelDifficulty === 3) {
          difficultyEnum = 'HARD';
        }

        const response = await fetch('http://localhost:8080/api/game/verify-answer', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + session,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            gameId: parseInt(gameId),
            questionNumber: currentQuestionNumber,
            submittedAnswerNumber: answerNumber,
            timeTakenToAnswerInSeconds: Math.round(timeTaken),
            session: session,
            levelDifficulty: difficultyEnum,
            questionId: currentQuestionData ? currentQuestionData.questionId : 0
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Ошибка HTTP: ${response.status}: ${errorText}`);
        }

        console.log('Ответ успешно отправлен');

        // Определяем правильность ответа (для отображения пользователю)
        let isCorrect = false;
        if (currentQuestionData && currentQuestionData.rightAnswerNumber) {
          isCorrect = (answerNumber === currentQuestionData.rightAnswerNumber);
        }

        setTimeout(() => {
          goToNextQuestion();
        }, 2000);

      } catch (error) {
        console.error('Ошибка отправки ответа:', error);
        // В случае ошибки показываем сообщение и переходим дальше
        showErrorMessage('Ошибка отправки ответа');
        setTimeout(() => {
          goToNextQuestion();
        }, 2000);
      }
    }

    function showErrorMessage(message) {
      const answersContainer = document.getElementById('answers-container');
      const errorMessage = document.createElement('div');
      errorMessage.className = 'error-message';
      errorMessage.textContent = message;
      answersContainer.appendChild(errorMessage);
    }

    function goToNextQuestion() {
      currentQuestionNumber++;

      // Проверяем, есть ли еще вопросы
      if (currentQuestionNumber <= totalQuestions) {
        loadQuestion();
      } else {
        // Квиз завершен - ждем 1 секунду перед переходом на результаты
        console.log('Квиз завершен! Переход к результатам...');
        window.location.href = `results.html?gameId=${gameId}`;
      }
    }

    // Обработка закрытия страницы
    window.addEventListener('beforeunload', function () {
      if (timerWorker) {
        timerWorker.terminate();
      }
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
    });

    // Защита от переключения вкладок
    document.addEventListener('visibilitychange', function() {
      if (document.hidden && !answerSubmitted) {
        console.log('Страница скрыта! Возможна попытка читерства.');
      }
    });
</script>

</html>