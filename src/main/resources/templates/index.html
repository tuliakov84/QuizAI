<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/styles/style.css">
  <title>QUIZAI</title>
</head>


<body>
  <div class="main_cont">
    <header>
      <h1>QUIZ AI</h1>
      <p>Вход в систему</p>
    </header>
    <main>
      <div class="main_rect">
        <div class="name">
          <span>Имя пользователя</span>
          <div class="input-group">
            <input type="text" name="username" placeholder="Имя пользователя" required>
          </div>
        </div>
        <div class="password">
          <span>Пароль</span>
          <div class="input-group">
            <input type="password" password="password" placeholder="Пароль" required>
          </div>
        </div>
        <div class="enter">
          <button type="button" class="btn">ВОЙТИ</button>
        </div>
        <div class="reg_href">
          <span>Еще нет аккаунта?</span>
          <a href="register.html">Зарегестрируйтесь сейчас</a>
        </div>
      </div>
    </main>
  </div>
</body>

<script src="/js/auth.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded - setting up login form');

        const loginBtn = document.querySelector('.enter .btn');
        const usernameInput = document.querySelector('input[name="username"]');
        const passwordInput = document.querySelector('input[password="password"]');

        // Прямой обработчик на кнопку
        loginBtn.addEventListener('click', async function (e) {
            e.preventDefault();
            console.log('Login button clicked');

            const username = usernameInput.value;
            const password = passwordInput.value;

            console.log('Username:', username, 'Password:', password);

            // Валидация
            if (!username || !password) {
                alert('Пожалуйста, заполните все поля');
                return;
            }

            try {
                // Показываем загрузку
                loginBtn.textContent = 'ВХОД...';
                loginBtn.disabled = true;

                console.log('Sending request to /api/auth/login');

                // Отправляем запрос на бэкенд
                const response = await fetch('http://localhost:8080/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                console.log('Response status:', response.status);

                // Получаем текст ответа для отладки
                const responseText = await response.text();
                console.log('Response text:', responseText);

                // Пробуем распарсить JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    alert('Ошибка сервера: неверный формат ответа');
                    return;
                }

                console.log('Parsed data:', data);

                // Проверяем успешный ответ
                if (response.ok && data.username) {
                    // Сохраняем токен и данные пользователя
                    localStorage.setItem('session', data.session);
                    localStorage.setItem('user', JSON.stringify(data));

                    console.log('Login successful!');
                    alert('Вход выполнен успешно!');
                    window.location.href = 'main.html';
                } else {
                    // Если пришла ошибка от сервера
                    const errorMessage = data.message || data.error || 'Неизвестная ошибка';
                    alert('Ошибка: ' + errorMessage);
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Ошибка соединения с сервером: ' + error.message);
            } finally {
                // Всегда возвращаем кнопку в исходное состояние
                loginBtn.textContent = 'ВОЙТИ';
                loginBtn.disabled = false;
            }
        });

        // Также добавим обработчик на Enter в полях ввода
        function handleEnterKey(e) {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        }

        usernameInput.addEventListener('keypress', handleEnterKey);
        passwordInput.addEventListener('keypress', handleEnterKey);

        console.log('Login form setup complete');
    });
</script>


</html>