<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles/createroom_style.css">
    <title>QUIZAI</title>
</head>

<body>
<div class="main_cont">
    <header>
        <a href="themesToCreate.html" class="btn_back">НАЗАД</a>
        <h1 class="h11">QUIZ AI ARENA</h1>
    </header>

    <main>
        <div class="main_blockl">
            <div class="tablehead">
                <p class="h12">ВЫБЕРИТЕ СЛОЖНОСТЬ:</p>
            </div>
            <a href="#" class="btn difficulty-btn" data-difficulty="3">
                <div class="text">
                    <h3>ТЯЖЕЛЫЙ КВИЗ</h3>
                </div>
            </a>
            <a href="#" class="btn difficulty-btn" data-difficulty="2">
                <div class="text">
                    <h3>СРЕДНИЙ КВИЗ</h3>
                </div>
            </a>
            <a href="#" class="btn difficulty-btn" data-difficulty="1">
                <div class="text">
                    <h3>ЛЕГКИЙ КВИЗ</h3>
                </div>
            </a>

            <!-- Информация о выбранной теме -->
            <div id="selected-topic-info" class="topic-info">
                <!-- Тема будет загружена через JavaScript -->
            </div>
        </div>

        <div class="right">
            <div class="main_blockr">
                <span>ПРИВАТНОСТЬ КОМНАТЫ</span>
                <div class="isprivate block_hor">
                    <a href="#" class="btnprivate privacy-btn" data-private="false">ОТКРЫТАЯ</a>
                    <a href="#" class="btnprivate privacy-btn" data-private="true">ЗАКРЫТАЯ</a>
                </div>

                <span>КОЛИЧЕСТВО УЧАСТНИКОВ</span>
                <div class="input-group">
                    <input type="number" id="participants-count" name="link" placeholder="<50 ЧЕЛОВЕК" min="2" max="50" value="4" required>
                </div>

                <span>КОЛИЧЕСТВО ВОПРОСОВ</span>
                <div class="input-group">
                    <input type="number" id="questions-count" name="link" placeholder="ОТ 10 ДО 30" min="10" max="30" value="10" required>
                </div>

            </div>
            <a href="#" class="btncreate" id="create-room-btn">СОЗДАТЬ КОМНАТУ</a>
            <div id="message" class="message"></div>
        </div>
    </main>
</div>

<script src="/js/auth.js"></script>
<script>
    let selectedTopic = null;
    let selectedDifficulty = 2; // По умолчанию средняя сложность
    let isPrivate = false; // По умолчанию открытая комната
    let isCreatingRoom = false; // Флаг для отслеживания процесса создания

    document.addEventListener('DOMContentLoaded', function() {
      if (!AuthService.requireAuth()) return;
      loadSelectedTopic();
      setupEventListeners();
    });

    // Загрузка выбранной темы
    function loadSelectedTopic() {
      try {
        const topicData = localStorage.getItem('selectedTopic');
        if (!topicData) {
          showMessage('Тема не выбрана. Возврат к выбору тем...', 'error');
          setTimeout(() => {
            window.location.href = 'themesToCreate.html';
          }, 2000);
          return;
        }

        selectedTopic = JSON.parse(topicData);
        displaySelectedTopic(selectedTopic);

      } catch (error) {
        console.error('Ошибка загрузки темы:', error);
        showMessage('Ошибка загрузки темы', 'error');
      }
    }

    // Отображение выбранной темы
    function displaySelectedTopic(topic) {
      const topicInfo = document.getElementById('selected-topic-info');
      topicInfo.innerHTML = `
        <div class="topic-card">
          <h4>ВЫБРАННАЯ ТЕМА:</h4>
          <h3>${topic.name}</h3>
        </div>
      `;
    }

    // Настройка обработчиков событий
    function setupEventListeners() {
      // Обработчики для кнопок сложности
      document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          if (isCreatingRoom) return; // Блокируем при создании

          // Снимаем выделение со всех кнопок сложности
          document.querySelectorAll('.difficulty-btn').forEach(b => {
            b.classList.remove('active');
          });

          // Выделяем выбранную кнопку
          this.classList.add('active');

          // Сохраняем выбранную сложность
          selectedDifficulty = parseInt(this.dataset.difficulty);

        });
      });

      // Обработчики для кнопок приватности
      document.querySelectorAll('.privacy-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          if (isCreatingRoom) return; // Блокируем при создании

          // Снимаем выделение со всех кнопок приватности
          document.querySelectorAll('.privacy-btn').forEach(b => {
            b.classList.remove('active');
          });

          // Выделяем выбранную кнопку
          this.classList.add('active');

          // Сохраняем выбранную приватность
          isPrivate = this.dataset.private === 'true';

        });
      });

      // Обработчик для создания комнаты
      const createBtn = document.getElementById('create-room-btn');
      createBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (isCreatingRoom) return; // Блокируем повторные нажатия
        createQuiz();
      });

      // Обработчики для полей ввода
      const participantsInput = document.getElementById('participants-count');
      const questionsInput = document.getElementById('questions-count');
      
      [participantsInput, questionsInput].forEach(input => {
        input.addEventListener('input', function() {
          if (isCreatingRoom) {
            this.value = this.defaultValue; // Не даем менять значения во время создания
          }
        });
      });

      // Устанавливаем среднюю сложность по умолчанию
      document.querySelector('.difficulty-btn[data-difficulty="2"]').classList.add('active');

      // Устанавливаем открытую комнату по умолчанию
      document.querySelector('.privacy-btn[data-private="false"]').classList.add('active');
    }

    // Блокировка/разблокировка интерфейса
    function setCreatingState(isCreating) {
      isCreatingRoom = isCreating;
      const createBtn = document.getElementById('create-room-btn');
      
      if (isCreating) {
        // Блокируем кнопку
        createBtn.classList.add('disabled');
        createBtn.innerHTML = 'СОЗДАНИЕ...';
        createBtn.style.opacity = '0.6';
        createBtn.style.cursor = 'not-allowed';
        
        // Блокируем все интерактивные элементы
        document.querySelectorAll('.difficulty-btn, .privacy-btn, input').forEach(el => {
          el.classList.add('disabled');
          el.style.pointerEvents = 'none';
          if (el.tagName === 'INPUT') {
            el.style.opacity = '0.6';
          }
        });
      } else {
        // Разблокируем кнопку
        createBtn.classList.remove('disabled');
        createBtn.innerHTML = 'СОЗДАТЬ КОМНАТУ';
        createBtn.style.opacity = '';
        createBtn.style.cursor = '';
        
        // Разблокируем все интерактивные элементы
        document.querySelectorAll('.difficulty-btn, .privacy-btn, input').forEach(el => {
          el.classList.remove('disabled');
          el.style.pointerEvents = '';
          if (el.tagName === 'INPUT') {
            el.style.opacity = '';
          }
        });
      }
    }

    // Создание квиза
    async function createQuiz() {
      if (!selectedTopic) {
        showMessage('Тема не выбрана', 'error');
        return;
      }

      const participantsCount = document.getElementById('participants-count').value;
      const questionsCount = document.getElementById('questions-count').value;

      // Валидация
      if (!participantsCount || participantsCount < 4 || participantsCount > 50) {
        showMessage('Количество участников должно быть от 4 до 50', 'error');
        return;
      }

      if (!questionsCount || questionsCount < 10 || questionsCount > 30) {
        showMessage('Количество вопросов должно быть от 10 до 30', 'error');
        return;
      }

      try {
        setCreatingState(true); // Блокируем интерфейс
        showMessage('Создание комнаты...', 'info');

        const session = AuthService.getsession();

        // Создание квиза
        const response = await fetch('http://localhost:8080/api/game/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            session: session,
            levelDifficulty: selectedDifficulty,
            numberOfQuestions: parseInt(questionsCount),
            participantsNumber: parseInt(participantsCount),
            topicId: selectedTopic.topicId,
            isPrivate: isPrivate
          })
        });

        if (!response.ok) {
          let errorMessage = `Ошибка HTTP: ${response.status}`;
          try {
            const errorData = await response.json();
            errorMessage = errorData.message || errorMessage;
          } catch (e) {
            // Не удалось распарсить JSON
          }
          throw new Error(errorMessage);
        }

        const createdGame = await response.json();

        showMessage('Комната успешно создана! Перенаправление...', 'success');

        // Сохраняем данные игры для использования в лобби
        sessionStorage.setItem('createdGame', JSON.stringify(createdGame));

        // Перенаправление на страницу лобби
        setTimeout(() => {
          window.location.href = `roomadmin.html?gameId=${createdGame.gameId}`;
        }, 2000);

      } catch (error) {
        console.error('Ошибка создания комнаты:', error);
        showMessage('Ошибка создания комнаты: ' + error.message, 'error');
        setCreatingState(false); // Разблокируем интерфейс при ошибке
      }
    }

    function showMessage(text, type) {
      const messageElement = document.getElementById('message');
      messageElement.textContent = text;
      messageElement.className = 'message ' + type;

      // Автоматически скрываем информационные сообщения через 3 секунды
      if (type === 'info' || type === 'success') {
        setTimeout(() => {
          if (messageElement.textContent === text) {
            messageElement.textContent = '';
            messageElement.className = 'message';
          }
        }, 3000);
      }
    }
</script>
</body>

</html>
[file content end]