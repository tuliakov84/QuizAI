<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/styles/connect1_style.css">
  <title>QUIZAI</title>
</head>

<body>
  <div class="main_cont">
    <header>
      <a href="main.html" class="btn_back">НАЗАД</a>
      <h1 class="h11">QUIZ AI AREA</h1>
    </header>

    <p class="h12">ХОЧУ ИГРАТЬ!</p>

    <main>
      <div class="main_block">
        <div class="block_hor">
          <div class="input-group">
            <input type="text" id="invite-link" name="link" placeholder="Ссылка-приглашение" required>
          </div>
          <button id="join-btn" class="btnr">ВОЙТИ</button>
        </div>
        <span> ИЛИ </span>
        <a href="themesToJoin.html" class="btnd">ВЫБРАТЬ ТЕМУ И ПРИСОЕДИНИТЬСЯ К ОТКРЫТОМУ КВИЗУ</a>
      </div>
    </main>
  </div>
</body>


<script src="/js/auth.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (!AuthService.requireAuth()) return;

    initializeEventHandlers();
  });

  function initializeEventHandlers() {
    const joinBtn = document.getElementById('join-btn');
    const inviteLinkInput = document.getElementById('invite-link');

    joinBtn.addEventListener('click', handleJoinRoom);
  }

  async function handleJoinRoom() {
    const inviteLink = document.getElementById('invite-link').value.trim();

    if (!inviteLink) {
      showError('Пожалуйста, введите ссылку-приглашение');
      return;
    }

    // Извлекаем код комнаты из ссылки
    const roomCode = extractRoomCode(inviteLink);
    if (!roomCode) {
      showError('Неверный формат ссылки-приглашения');
      return;
    }

    // Показываем индикатор загрузки
    const joinBtn = document.getElementById('join-btn');
    joinBtn.textContent = 'ПОДКЛЮЧЕНИЕ...';
    joinBtn.disabled = true;

    try {
      // Пытаемся подключиться к комнате
      const result = await joinRoomByCode(roomCode);

      if (result.success) {
        // Сохраняем информацию о комнате
        localStorage.setItem('currentRoom', JSON.stringify(result.room));

        // Перенаправляем в комнату
        window.location.href = 'roommember.html';
      } else {
        showError(result.message || 'Не удалось подключиться к комнате');
      }
    } catch (error) {
      console.error('Ошибка подключения к комнате:', error);
      showError('Ошибка подключения к серверу');
    } finally {
      // Восстанавливаем кнопку
      joinBtn.textContent = 'ВОЙТИ';
      joinBtn.disabled = false;
    }
  }

  function extractRoomCode(inviteLink) {
    // Обрабатываем разные форматы ссылок:

    // 1. Прямой код комнаты (например: "ABC123")
    if (/^[A-Z0-9]{6}$/i.test(inviteLink)) {
      return inviteLink.toUpperCase();
    }

    // 2. Полная ссылка (например: "https://quizai.com/join/ABC123")
    const urlPatterns = [
      /\/join\/([A-Z0-9]{6})/i,
      /room\/([A-Z0-9]{6})/i,
      /code=([A-Z0-9]{6})/i,
      /invite\/([A-Z0-9]{6})/i
    ];

    for (const pattern of urlPatterns) {
      const match = inviteLink.match(pattern);
      if (match && match[1]) {
        return match[1].toUpperCase();
      }
    }

    return null;
  }

  async function joinRoomByCode(roomCode) {
    const session = AuthService.getsession();

    try {
      const response = await fetch(`http://localhost:8080/api/rooms/join`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${session}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          code: gameCode
        })
      });

      if (response.ok) {
        const roomData = await response.json();
        return {
          success: true,
          game: gameData
        };
      } else if (response.status === 404) {
        return {
          success: false,
          message: 'Комната не найдена'
        };
      } else if (response.status === 400) {
        return {
          success: false,
          message: 'Комната уже начата или завершена'
        };
      } else if (response.status === 403) {
        return {
          success: false,
          message: 'Нет доступа к комнате'
        };
      } else {
        return {
          success: false,
          message: 'Ошибка подключения к комнате'
        };
      }
    } catch (error) {
      console.error('Ошибка при подключении к комнате:', error);
      throw error;
    }
  }

  function showError(message) {
    // Удаляем существующие сообщения об ошибках
    const existingError = document.querySelector('.error-message');
    if (existingError) {
      existingError.remove();
    }

    // Создаем элемент для отображения ошибки
    const errorElement = document.createElement('div');
    errorElement.className = 'error-message';
    errorElement.textContent = message;
    errorElement.style.cssText = `
        background-color: #ffebee;
        color: #c62828;
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
        text-align: center;
        border: 1px solid #ffcdd2;
    `;

    // Вставляем сообщение об ошибке после блока с полем ввода
    const mainBlock = document.querySelector('.main_block');
    mainBlock.parentNode.insertBefore(errorElement, mainBlock);

    // Автоматически скрываем через 5 секунд
    setTimeout(() => {
      errorElement.remove();
    }, 5000);
  }
</script>

</html>